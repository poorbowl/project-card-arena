<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Card Arena - Deckbuilder</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- Custom Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        .card-item {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            min-height: 220px; /* Ensure cards have a consistent minimum height */
        }
        .card-item:hover {
            transform: scale(1.03);
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.5); /* Indigo glow */
        }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-900 text-white p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-white">Project Card Arena</h1>
            <p class="text-xl text-gray-400">Advanced Deckbuilding Tool</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- ==================================================== -->
            <!-- Column 1: Card Creator and Full Card Collection      -->
            <!-- ==================================================== -->
            <div class="lg:col-span-1 space-y-8">
                <!-- Card Creator Section -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 border-b border-gray-600 pb-2">1. Add Cards to Collection</h2>
                    
                    <!-- Tabs for Manual/Bulk -->
                    <div class="mb-4 border-b border-gray-600">
                        <nav class="flex -mb-px" id="creatorTabs">
                            <button data-tab="manual" class="tab-button bg-gray-700 text-white py-2 px-4 rounded-t-lg">Manual Entry</button>
                            <button data-tab="bulk" class="tab-button py-2 px-4 text-gray-400">Bulk Import</button>
                        </nav>
                    </div>

                    <!-- Manual Entry Form -->
                    <div id="manualTabContent" class="space-y-4">
                        <div>
                            <label for="cardType" class="block text-sm font-medium text-gray-300">Card Type*</label>
                            <select id="cardType" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option>Creature</option>
                                <option>Planeswalker</option>
                                <option>Instant</option>
                                <option>Sorcery</option>
                                <option>Enchantment</option>
                                <option>Artifact</option>
                                <option>Land</option>
                            </select>
                        </div>
                        <div>
                            <label for="cardName" class="block text-sm font-medium text-gray-300">Card Name*</label>
                            <input type="text" id="cardName" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white">
                        </div>
                        <div>
                            <label for="manaCost" class="block text-sm font-medium text-gray-300">Mana Cost* <span class="text-xs text-gray-400">(e.g., {2}{W}{U})</span></label>
                            <input type="text" id="manaCost" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white">
                        </div>
                         <div>
                            <label for="cardText" class="block text-sm font-medium text-gray-300">Text Box*</label>
                            <textarea id="cardText" rows="3" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white"></textarea>
                        </div>
                        <!-- Conditional Fields -->
                        <div id="powerToughnessFields" class="hidden grid grid-cols-2 gap-4">
                             <div>
                                <label for="power" class="block text-sm font-medium text-gray-300">Power*</label>
                                <input type="number" id="power" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white">
                            </div>
                            <div>
                                <label for="toughness" class="block text-sm font-medium text-gray-300">Toughness*</label>
                                <input type="number" id="toughness" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white">
                            </div>
                        </div>
                        <div id="loyaltyFields" class="hidden">
                            <label for="loyalty" class="block text-sm font-medium text-gray-300">Starting Loyalty*</label>
                            <input type="number" id="loyalty" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white">
                        </div>
                        <div>
                            <label for="cardImage" class="block text-sm font-medium text-gray-300">Card Image (Optional)</label>
                            <input type="file" id="cardImage" accept="image/*" class="mt-1 block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-500 file:text-white hover:file:bg-indigo-600">
                        </div>
                        <button id="addCardBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Add to Collection</button>
                    </div>

                    <!-- Bulk Import Form -->
                    <div id="bulkTabContent" class="hidden space-y-4">
                        <p class="text-sm text-gray-300">Import cards from a `.csv` file. See format instructions below.</p>
                         <div>
                            <label for="csvFile" class="block text-sm font-medium text-gray-300">CSV File*</label>
                            <input type="file" id="csvFile" accept=".csv" class="mt-1 block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-500 file:text-white hover:file:bg-indigo-600">
                        </div>
                        <div>
                            <label for="imageFiles" class="block text-sm font-medium text-gray-300">Card Images (Optional)</label>
                            <input type="file" id="imageFiles" accept="image/*" multiple class="mt-1 block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-500 file:text-white hover:file:bg-indigo-600">
                        </div>
                        <div class="text-xs text-gray-400 p-2 bg-gray-700 rounded">
                            <p class="font-bold">CSV Columns:</p>
                            `Card Name`, `Card Type`, `Mana Cost`, `Text Box`, `Power`, `Toughness`, `Starting Loyalty`, `Image Filename`
                        </div>
                        <button id="importBtn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Import Cards</button>
                        <div id="importStatus" class="text-sm text-center"></div>
                    </div>
                </div>

                <!-- Full Card Collection Section -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 border-b border-gray-600 pb-2">My Card Collection</h2>
                    <div id="cardCollection" class="h-96 overflow-y-auto grid grid-cols-1 gap-4 custom-scrollbar pr-2">
                        <!-- Dynamically populated card collection -->
                    </div>
                </div>
            </div>

            <!-- ==================================================== -->
            <!-- Column 2 & 3 are unchanged for now -->
            <!-- ==================================================== -->
            <div class="lg:col-span-1 bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 border-b border-gray-600 pb-2">2. Assemble Deck</h2>
                <div>
                    <label for="deckName" class="block text-sm font-medium text-gray-300">Deck Name</label>
                    <input type="text" id="deckName" placeholder="e.g., My Awesome Dragon Deck" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white">
                </div>
                <div class="mt-4">
                    <p class="text-sm text-gray-400">Add cards from your collection by clicking them.</p>
                    <p id="deckCount" class="font-bold text-lg mt-2">Current Deck: 0 Cards</p>
                </div>
                <div id="currentDeck" class="mt-4 h-[34rem] overflow-y-auto grid grid-cols-2 sm:grid-cols-3 gap-4 custom-scrollbar pr-2">
                </div>
                 <button id="saveDeckBtn" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Save Current Deck</button>
            </div>

            <div class="lg:col-span-1 bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 border-b border-gray-600 pb-2">3. Saved Decks</h2>
                <div id="savedDecksList" class="space-y-3 h-[42rem] overflow-y-auto custom-scrollbar pr-2">
                </div>
            </div>

        </main>
    </div>

    <script>
        // Store references to all DOM elements we'll need
        const elements = {
            // Card Creator (Manual)
            cardType: document.getElementById('cardType'),
            cardName: document.getElementById('cardName'),
            manaCost: document.getElementById('manaCost'),
            cardText: document.getElementById('cardText'),
            powerToughnessFields: document.getElementById('powerToughnessFields'),
            power: document.getElementById('power'),
            toughness: document.getElementById('toughness'),
            loyaltyFields: document.getElementById('loyaltyFields'),
            loyalty: document.getElementById('loyalty'),
            cardImage: document.getElementById('cardImage'),
            addCardBtn: document.getElementById('addCardBtn'),
            
            // Card Creator (Bulk)
            csvFile: document.getElementById('csvFile'),
            imageFiles: document.getElementById('imageFiles'),
            importBtn: document.getElementById('importBtn'),
            importStatus: document.getElementById('importStatus'),

            // Tabs
            creatorTabs: document.getElementById('creatorTabs'),
            manualTabContent: document.getElementById('manualTabContent'),
            bulkTabContent: document.getElementById('bulkTabContent'),

            // Collections & Decks
            cardCollectionDiv: document.getElementById('cardCollection'),
            deckNameInput: document.getElementById('deckName'),
            deckCountP: document.getElementById('deckCount'),
            currentDeckDiv: document.getElementById('currentDeck'),
            saveDeckBtn: document.getElementById('saveDeckBtn'),
            savedDecksListDiv: document.getElementById('savedDecksList'),
        };

        // App state variables
        let cardCollection = [];
        let currentDeck = [];
        let savedDecks = {};

        // ====================================================
        // DATA PERSISTENCE (localStorage) - Unchanged
        // ====================================================
        const loadFromLocalStorage = () => {
            cardCollection = JSON.parse(localStorage.getItem('cardCollection') || '[]');
            savedDecks = JSON.parse(localStorage.getItem('savedDecks') || '{}');
        };
        const saveCollectionToLocalStorage = () => localStorage.setItem('cardCollection', JSON.stringify(cardCollection));
        const saveDecksToLocalStorage = () => localStorage.setItem('savedDecks', JSON.stringify(savedDecks));

        // ====================================================
        // UI RENDERING FUNCTIONS
        // ====================================================

        /**
         * Creates an HTML element for a single card with detailed info.
         * @param {object} card - The full card object.
         * @param {string} type - 'collection' or 'deck'.
         * @returns {HTMLElement} The card element.
         */
        function createCardElement(card, type) {
            const cardEl = document.createElement('div');
            cardEl.className = 'card-item cursor-pointer bg-gray-700 rounded-lg p-3 flex gap-3';

            let ptHtml = '';
            if (card.type === 'Creature' && card.power !== undefined) {
                ptHtml = `<div class="absolute bottom-1 right-2 bg-gray-800 px-2 py-1 text-sm rounded-md font-bold">${card.power}/${card.toughness}</div>`;
            } else if (card.type === 'Planeswalker' && card.loyalty !== undefined) {
                 ptHtml = `<div class="absolute bottom-1 right-2 bg-indigo-800 px-2 py-1 text-sm rounded-md font-bold">[${card.loyalty}]</div>`;
            }

            cardEl.innerHTML = `
                ${card.imageSrc ? `<img src="${card.imageSrc}" alt="${card.name}" class="w-1/3 h-auto object-cover rounded-md">` : `<div class="w-1/3 bg-gray-600 rounded-md flex items-center justify-center text-gray-400 text-xs">No Img</div>`}
                <div class="w-2/3 relative">
                    <p class="font-bold text-sm truncate">${card.name}</p>
                    <p class="text-xs text-gray-400">${card.type}</p>
                    <p class="text-xs text-indigo-300">${card.manaCost}</p>
                    <p class="text-[10px] text-gray-300 mt-1 whitespace-pre-wrap">${card.text.substring(0, 50)}${card.text.length > 50 ? '...' : ''}</p>
                    ${ptHtml}
                </div>
            `;
            
            if (type === 'collection') {
                cardEl.onclick = () => addCardToDeck(card);
            } else if (type === 'deck') {
                cardEl.onclick = () => removeCardFromDeck(card.deckInstanceId);
            }
            
            return cardEl;
        }
        
        // --- Other render functions (renderCardCollection, renderCurrentDeck, renderSavedDecks) are mostly the same,
        // --- but they now call the new createCardElement function.
        const renderCardCollection = () => {
            elements.cardCollectionDiv.innerHTML = '';
            // For the main collection, let's use a simpler view for density
            const collectionGrid = document.createElement('div');
            collectionGrid.className = "grid grid-cols-2 sm:grid-cols-3 gap-4";
            cardCollection.forEach(card => {
                 const cardEl = document.createElement('div');
                cardEl.className = 'card-item cursor-pointer bg-gray-700 rounded-lg overflow-hidden p-2 flex flex-col items-center';
                cardEl.innerHTML = `
                    <img src="${card.imageSrc || 'https://placehold.co/100x140/2d3748/e2e8f0?text=No+Img'}" alt="${card.name}" class="w-full h-auto object-cover rounded-md mb-2">
                    <p class="text-xs text-center font-medium truncate w-full">${card.name}</p>
                `;
                cardEl.onclick = () => addCardToDeck(card);
                collectionGrid.appendChild(cardEl);
            });
            elements.cardCollectionDiv.innerHTML = '';
            elements.cardCollectionDiv.appendChild(collectionGrid);
        };

        const renderCurrentDeck = () => {
            elements.currentDeckDiv.innerHTML = '';
            currentDeck.forEach(card => {
                const cardEl = createCardElement(card, 'deck');
                elements.currentDeckDiv.appendChild(cardEl);
            });
            elements.deckCountP.textContent = `Current Deck: ${currentDeck.length} Cards`;
        };

        const renderSavedDecks = () => {
            elements.savedDecksListDiv.innerHTML = '';
            for (const deckName in savedDecks) {
                const deck = savedDecks[deckName];
                const deckEl = document.createElement('div');
                deckEl.className = 'bg-gray-700 p-3 rounded-lg flex justify-between items-center';
                deckEl.innerHTML = `
                    <div>
                        <h4 class="font-semibold">${deckName}</h4>
                        <p class="text-sm text-gray-400">${deck.length} cards</p>
                    </div>
                    <div class="flex gap-2">
                        <button class="load-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-sm">Load</button>
                        <button class="delete-btn bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-sm">Delete</button>
                    </div>`;
                deckEl.querySelector('.load-btn').onclick = () => loadDeck(deckName);
                deckEl.querySelector('.delete-btn').onclick = () => deleteDeck(deckName);
                elements.savedDecksListDiv.appendChild(deckEl);
            }
        };

        // ====================================================
        // EVENT HANDLERS & LOGIC
        // ====================================================

        /**
         * Toggles visibility of P/T and Loyalty fields based on selected card type.
         */
        const handleCardTypeChange = () => {
            const type = elements.cardType.value;
            elements.powerToughnessFields.classList.toggle('hidden', type !== 'Creature');
            elements.loyaltyFields.classList.toggle('hidden', type !== 'Planeswalker');
        };

        /**
         * Handles the click on the Manual/Bulk tabs.
         */
        const handleTabClick = (e) => {
            if (!e.target.matches('.tab-button')) return;

            const tab = e.target.dataset.tab;
            
            elements.creatorTabs.querySelectorAll('.tab-button').forEach(button => {
                const isSelected = button.dataset.tab === tab;
                button.classList.toggle('bg-gray-700', isSelected);
                button.classList.toggle('text-white', isSelected);
                button.classList.toggle('text-gray-400', !isSelected);
            });
            
            elements.manualTabContent.classList.toggle('hidden', tab !== 'manual');
            elements.bulkTabContent.classList.toggle('hidden', tab !== 'bulk');
        };

        /**
         * Handles adding a single new card from the manual form.
         */
        const handleAddCard = () => {
            const imageFile = elements.cardImage.files[0];
            const newCard = {
                id: Date.now(),
                type: elements.cardType.value,
                name: elements.cardName.value.trim(),
                manaCost: elements.manaCost.value.trim(),
                text: elements.cardText.value.trim(),
                power: elements.power.value,
                toughness: elements.toughness.value,
                loyalty: elements.loyalty.value,
                imageSrc: null,
            };

            // Basic Validation
            if (!newCard.name || !newCard.manaCost || !newCard.text) {
                alert('Please fill all required fields (*).');
                return;
            }

            if (imageFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    newCard.imageSrc = e.target.result;
                    finalizeCardAdd(newCard);
                };
                reader.readAsDataURL(imageFile);
            } else {
                finalizeCardAdd(newCard);
            }
        };

        const finalizeCardAdd = (card) => {
            cardCollection.push(card);
            saveCollectionToLocalStorage();
            renderCardCollection();
            // Reset form fields
            elements.cardName.value = '';
            elements.manaCost.value = '';
            elements.cardText.value = '';
            elements.power.value = '';
            elements.toughness.value = '';
            elements.loyalty.value = '';
            elements.cardImage.value = '';
        };

        /**
         * Handles the bulk import process.
         */
        const handleBulkImport = async () => {
            const csvFile = elements.csvFile.files[0];
            const imageFiles = elements.imageFiles.files;

            if (!csvFile) {
                alert('Please select a CSV file.');
                return;
            }

            elements.importStatus.textContent = 'Importing... Please wait.';

            // 1. Read all image files into a map for quick lookup
            const imageMap = new Map();
            const imagePromises = Array.from(imageFiles).map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imageMap.set(file.name, e.target.result);
                        resolve();
                    };
                    reader.readAsDataURL(file);
                });
            });
            await Promise.all(imagePromises);
            
            // 2. Parse CSV and create card objects
            Papa.parse(csvFile, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    let addedCount = 0;
                    results.data.forEach(row => {
                        if (row['Card Name'] && row['Card Type'] && row['Mana Cost'] && row['Text Box']) {
                             const newCard = {
                                id: Date.now() + Math.random(),
                                name: row['Card Name'] || '',
                                type: row['Card Type'] || '',
                                manaCost: row['Mana Cost'] || '',
                                text: row['Text Box'] || '',
                                power: row['Power'] || '',
                                toughness: row['Toughness'] || '',
                                loyalty: row['Starting Loyalty'] || '',
                                imageSrc: imageMap.get(row['Image Filename']) || null,
                            };
                            cardCollection.push(newCard);
                            addedCount++;
                        }
                    });
                    
                    saveCollectionToLocalStorage();
                    renderCardCollection();
                    elements.importStatus.textContent = `Successfully imported ${addedCount} cards!`;
                    elements.csvFile.value = '';
                    elements.imageFiles.value = '';
                },
                error: (err) => {
                     elements.importStatus.textContent = `Error parsing CSV: ${err.message}`;
                }
            });
        };

        // --- Deck manipulation functions (addCardToDeck, removeCardFromDeck, etc.) are largely unchanged ---
        const addCardToDeck = (card) => {
            const cardInstance = { ...card, deckInstanceId: Date.now() + Math.random() };
            currentDeck.push(cardInstance);
            renderCurrentDeck();
        };
        const removeCardFromDeck = (deckInstanceId) => {
            currentDeck = currentDeck.filter(card => card.deckInstanceId !== deckInstanceId);
            renderCurrentDeck();
        };
        const handleSaveDeck = () => {
            const name = elements.deckNameInput.value.trim();
            if (!name) { alert('Please enter a name for your deck.'); return; }
            if (currentDeck.length === 0) { alert('Cannot save an empty deck.'); return; }
            savedDecks[name] = [...currentDeck];
            saveDecksToLocalStorage();
            renderSavedDecks();
            alert(`Deck "${name}" saved successfully!`);
        };
        const loadDeck = (deckName) => {
            if (savedDecks[deckName]) {
                elements.deckNameInput.value = deckName;
                currentDeck = [...savedDecks[deckName]];
                renderCurrentDeck();
            }
        };
        const deleteDeck = (deckName) => {
            if (confirm(`Are you sure you want to delete the deck "${deckName}"?`)) {
                delete savedDecks[deckName];
                saveDecksToLocalStorage();
                renderSavedDecks();
            }
        };

        // ====================================================
        // INITIALIZATION
        // ====================================================
        const initializeApp = () => {
            // Attach all event listeners
            elements.cardType.addEventListener('change', handleCardTypeChange);
            elements.creatorTabs.addEventListener('click', handleTabClick);
            elements.addCardBtn.addEventListener('click', handleAddCard);
            elements.importBtn.addEventListener('click', handleBulkImport);
            elements.saveDeckBtn.addEventListener('click', handleSaveDeck);

            loadFromLocalStorage();
            renderCardCollection();
            renderCurrentDeck();
            renderSavedDecks();
            handleCardTypeChange(); // Set initial visibility of conditional fields
        };
        
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>
